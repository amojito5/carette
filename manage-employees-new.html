<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion - Carette RSE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        h1 {
            font-size: 28px;
            font-weight: 800;
            color: #1e293b;
        }
        .settings-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .settings-btn:hover {
            background: #5568d3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            font-size: 12px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-active {
            background: #d1fae5;
            color: #065f46;
        }
        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 4px;
        }
        .btn-deactivate {
            background: #fee2e2;
            color: #991b1b;
        }
        .btn-reactivate {
            background: #d1fae5;
            color: #065f46;
        }
        .btn-delete {
            background: #7f1d1d;
            color: white;
        }
        .filter-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 8px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #64748b;
        }
        .site-list { margin: 20px 0; }
        .site-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .site-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .site-address {
            font-size: 14px;
            color: #64748b;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        .autocomplete-container { position: relative; }
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .autocomplete-results.show { display: block; }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .autocomplete-item:hover { background: #f9fafb; }
        #sites-map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Gestion de l'entreprise</h1>
            <div style="display: flex; gap: 8px;">
                <button class="settings-btn" style="background: #e5e7eb; color: #374151;" onclick="window.location.href='dashboard-company.html?company_id=' + COMPANY_ID + '&access_key=' + ACCESS_KEY">
                    üìä Dashboard
                </button>
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Configuration</button>
            </div>
        </div>
        
        <div class="filter-tabs">
            <button class="tab active" onclick="filterUsers('all')">Tous</button>
            <button class="tab" onclick="filterUsers('active')">‚úÖ Actifs</button>
            <button class="tab" onclick="filterUsers('inactive')">‚ùå Inactifs</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Adresse</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-tbody">
                <tr><td colspan="6" style="text-align:center;padding:40px;">Chargement...</td></tr>
            </tbody>
        </table>
    </div>
    
    <!-- Modal Configuration -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuration</h2>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            
            <h3>üìç Sites de l'entreprise</h3>
            <div id="sites-list" class="site-list"></div>
            <div id="sites-map"></div>
            
            <h4 style="margin:24px 0 16px;">Ajouter un site</h4>
            <form id="add-site-form">
                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" id="new-site-name" placeholder="Si√®ge, Entrep√¥t..." required>
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <div class="autocomplete-container">
                        <input type="text" id="new-site-address" placeholder="Rechercher..." 
                               oninput="searchAddress(this)" required>
                        <div class="autocomplete-results" id="modal-autocomplete"></div>
                    </div>
                </div>
                <button type="submit" class="btn" style="background:#667eea;color:white;width:100%;padding:12px;">‚ûï Ajouter</button>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/v2';
        
        // R√©cup√©rer les param√®tres depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const MAGIC_TOKEN = urlParams.get('token') || localStorage.getItem('admin_magic_token') || '';
        const ACCESS_KEY = urlParams.get('access_key') || '';
        let COMPANY_ID = urlParams.get('company_id') || localStorage.getItem('company_id') || null;
        
        // V√©rifier l'authentification via magic token ou access_key
        async function checkAuth() {
            // Si on a company_id et access_key directement, pas besoin de v√©rifier le token
            if (COMPANY_ID && ACCESS_KEY) {
                localStorage.setItem('company_id', COMPANY_ID);
                localStorage.setItem('access_key', ACCESS_KEY);
                return true;
            }
            
            if (!MAGIC_TOKEN) {
                alert('‚ö†Ô∏è Acc√®s non autoris√©. Utilisez le lien re√ßu par email.');
                window.location.href = '/signup.html';
                return false;
            }
            
            try {
                // V√©rifier le token et r√©cup√©rer company_id
                const response = await fetch(`/api/v2/auth/verify-admin-token?token=${MAGIC_TOKEN}`);
                
                if (!response.ok) {
                    alert('‚ö†Ô∏è Lien invalide ou expir√©. Contactez le support.');
                    localStorage.clear();
                    window.location.href = '/signup.html';
                    return false;
                }
                
                const data = await response.json();
                COMPANY_ID = data.company_id;
                
                // Sauvegarder pour la session
                localStorage.setItem('admin_magic_token', MAGIC_TOKEN);
                localStorage.setItem('company_id', COMPANY_ID);
                
                return true;
            } catch (error) {
                console.error('Erreur auth:', error);
                return false;
            }
        }
        
        // V√©rifier auth au chargement
        checkAuth().then(isAuth => {
            if (!isAuth) return;
            loadUsers();
        });
        
        let allUsers = [];
        let currentFilter = 'all';
        let sitesMap, siteMarkers = [], allSites = [];
        
        async function loadUsers() {
            if (!COMPANY_ID) return;
            
            try {
                const res = await fetch(`${API_BASE}/rse/users/list?company_id=${COMPANY_ID}`);
                const data = await res.json();
                allUsers = data.users || [];
                displayUsers();
            } catch (e) {
                console.error(e);
            }
        }
        
        function displayUsers() {
            const tbody = document.getElementById('users-tbody');
            let filtered = allUsers;
            
            if (currentFilter === 'active') filtered = allUsers.filter(u => u.active);
            else if (currentFilter === 'inactive') filtered = allUsers.filter(u => !u.active);
            
            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">Aucun utilisateur</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td><strong>${u.name}</strong></td>
                    <td>${u.email}</td>
                    <td>${u.departure_address || '-'}</td>
                    <td><span class="status-badge ${u.active ? 'status-active' : 'status-inactive'}">${u.active ? '‚úÖ Actif' : '‚ùå Inactif'}</span></td>
                    <td>
                        ${u.active ?
                            `<button class="btn btn-deactivate" onclick="toggleUser(${u.id},false)">D√©sactiver</button>
                             <button class="btn btn-delete" onclick="deleteUser(${u.id},'${u.name.replace(/'/g,"\\'")}')">Supprimer</button>` :
                            `<button class="btn btn-reactivate" onclick="toggleUser(${u.id},true)">R√©activer</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }
        
        function filterUsers(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            displayUsers();
        }
        
        async function toggleUser(userId, activate) {
            if (!confirm(`${activate ? 'R√©activer' : 'D√©sactiver'} cet utilisateur ?`)) return;
            
            try {
                await fetch(`${API_BASE}/rse/users/${userId}/${activate ? 'reactivate' : 'deactivate'}`, {method: 'POST'});
                alert('Utilisateur ' + (activate ? 'r√©activ√©' : 'd√©sactiv√©'));
                loadUsers();
            } catch (e) {
                alert('Erreur');
            }
        }
        
        async function deleteUser(userId, name) {
            if (!confirm(`‚ö†Ô∏è Supprimer ${name} ?\nL'historique sera conserv√©.`)) return;
            
            try {
                await fetch(`${API_BASE}/rse/users/${userId}/delete`, {method: 'POST'});
                alert('Utilisateur supprim√©');
                loadUsers();
            } catch (e) {
                alert('Erreur');
            }
        }
        
        // Sites
        function openSettings() {
            document.getElementById('settings-modal').classList.add('show');
            loadSites();
            if (!sitesMap) {
                setTimeout(() => {
                    sitesMap = L.map('sites-map').setView([46.6, 1.9], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(sitesMap);
                    setTimeout(() => sitesMap.invalidateSize(), 100);
                }, 100);
            }
        }
        
        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('show');
        }
        
        async function loadSites() {
            try {
                const res = await fetch(`${API_BASE}/companies/${COMPANY_ID}/sites?include_inactive=true`);
                const data = await res.json();
                allSites = data.sites || [];
                displaySites();
                updateMap();
            } catch (e) {}
        }
        
        function displaySites() {
            const list = document.getElementById('sites-list');
            if (!allSites.length) {
                list.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">Aucun site</p>';
                return;
            }
            list.innerHTML = allSites.map(s => `
                <div class="site-item" style="opacity: ${s.active ? 1 : 0.6}">
                    <div style="flex: 1;">
                        <div class="site-name">
                            üìç ${s.site_name}
                            <span class="status-badge ${s.active ? 'status-active' : 'status-inactive'}" style="margin-left: 8px;">
                                ${s.active ? '‚úÖ Actif' : '‚ùå Inactif'}
                            </span>
                        </div>
                        <div class="site-address">${s.site_address}</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${s.active ?
                            `<button class="btn btn-deactivate" onclick="toggleSite(${s.id}, false, '${s.site_name.replace(/'/g,"\\'")}')">D√©sactiver</button>` :
                            `<button class="btn btn-reactivate" onclick="toggleSite(${s.id}, true, '${s.site_name.replace(/'/g,"\\'")}')">R√©activer</button>`
                        }
                    </div>
                </div>
            `).join('');
        }
        
        function updateMap() {
            if (!sitesMap) return;
            siteMarkers.forEach(m => sitesMap.removeLayer(m));
            siteMarkers = [];
            const bounds = [];
            
            // Afficher uniquement les sites actifs sur la carte
            allSites.filter(s => s.active).forEach(s => {
                if (s.site_coords) {
                    const c = typeof s.site_coords === 'string' ? JSON.parse(s.site_coords) : s.site_coords;
                    if (c && c.lat && c.lon) {
                        const m = L.marker([c.lat, c.lon]).addTo(sitesMap);
                        m.bindPopup(`<strong>${s.site_name}</strong><br>${s.site_address}`);
                        siteMarkers.push(m);
                        bounds.push([c.lat, c.lon]);
                    }
                }
            });
            if (bounds.length) sitesMap.fitBounds(bounds, {padding: [50, 50]});
        }
        
        async function toggleSite(id, activate, name) {
            if (!confirm(`${activate ? 'R√©activer' : 'D√©sactiver'} le site "${name}" ?`)) return;
            
            try {
                if (activate) {
                    await fetch(`${API_BASE}/companies/${COMPANY_ID}/sites/${id}/reactivate`, {method: 'POST'});
                } else {
                    await fetch(`${API_BASE}/companies/${COMPANY_ID}/sites/${id}`, {method: 'DELETE'});
                }
                alert('Site ' + (activate ? 'r√©activ√©' : 'd√©sactiv√©'));
                loadSites();
            } catch (e) {
                alert('Erreur');
            }
        }
        
        // Autocomplete
        let searchTimeout;
        async function searchAddress(input) {
            clearTimeout(searchTimeout);
            const query = input.value.trim();
            const results = document.getElementById('modal-autocomplete');
            
            if (query.length < 3) {
                results.classList.remove('show');
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=fr&limit=5`);
                const data = await res.json();
                
                if (!data.length) {
                    results.innerHTML = '<div class="autocomplete-item" style="color:#9ca3af;">Aucun r√©sultat</div>';
                    results.classList.add('show');
                    return;
                }
                
                results.innerHTML = data.map(r => `<div class="autocomplete-item" data-address="${r.display_name.replace(/"/g,'&quot;')}">${r.display_name}</div>`).join('');
                results.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.onclick = () => {
                        input.value = item.dataset.address;
                        results.classList.remove('show');
                    };
                });
                results.classList.add('show');
            }, 300);
        }
        
        document.addEventListener('click', e => {
            if (!e.target.matches('#new-site-address')) {
                document.getElementById('modal-autocomplete').classList.remove('show');
            }
        });
        
        document.getElementById('add-site-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-site-name').value.trim();
            const address = document.getElementById('new-site-address').value.trim();
            
            try {
                const res = await fetch(`${API_BASE}/companies/${COMPANY_ID}/sites`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({site_name: name, site_address: address})
                });
                if (!res.ok) throw new Error();
                alert('Site ajout√© !');
                document.getElementById('add-site-form').reset();
                loadSites();
            } catch (e) {
                alert('Erreur');
            }
        });
        
        loadUsers();
    </script>
</body>
</html>
