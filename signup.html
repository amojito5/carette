<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription Entreprise - Carette</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 48px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .logo {
            text-align: center;
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        h1 {
            text-align: center;
            font-size: 32px;
            font-weight: 900;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .subtitle {
            text-align: center;
            color: #64748b;
            margin-bottom: 40px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 32px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }
        
        .help-text {
            font-size: 13px;
            color: #64748b;
            margin-top: 6px;
        }
        
        .error {
            color: #dc2626;
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }
        
        .success-message {
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
            display: none;
        }
        
        .success-message h3 {
            color: #059669;
            font-size: 20px;
            margin-bottom: 12px;
        }
        
        .success-message p {
            color: #047857;
            line-height: 1.6;
        }
        
        .code-box {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: 900;
            color: #667eea;
            letter-spacing: 2px;
        }
        
        .back-link {
            text-align: center;
            margin-top: 24px;
        }
        
        .back-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
        
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin: 20px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-top: 3px;
        }
        
        .checkbox-group label {
            margin: 0;
            font-weight: 400;
            font-size: 13px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .autocomplete-results.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #334155;
        }
        
        .autocomplete-item:hover {
            background: #f8fafc;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        #sites-map {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            margin-top: 16px;
            border: 2px solid #e2e8f0;
        }
        
        .map-container {
            margin-bottom: 24px;
        }
        
        .site-entry {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üöó</div>
        <h1>Inscription Entreprise</h1>
        <p class="subtitle">D√©marrez votre essai gratuit en 2 minutes</p>
        
        <form id="signup-form">
            <div class="form-group">
                <label for="company-name">Nom de l'entreprise *</label>
                <input type="text" id="company-name" required placeholder="Ex: TechCorp SAS">
            </div>
            
            <div class="form-group">
                <label for="siren">SIREN (optionnel)</label>
                <input type="text" id="siren" pattern="[0-9]{9}" placeholder="123456789">
                <p class="help-text">9 chiffres sans espaces</p>
            </div>
            
            <div class="form-group">
                <label for="email-domain">Domaine email entreprise *</label>
                <input type="text" id="email-domain" required placeholder="techcorp.fr">
                <p class="help-text">Vos employ√©s avec @techcorp.fr seront auto-assign√©s</p>
            </div>
            
            <div class="form-group">
                <label for="contact-name">Votre nom *</label>
                <input type="text" id="contact-name" required placeholder="Jean Dupont">
            </div>
            
            <div class="form-group">
                <label for="contact-email">Votre email professionnel *</label>
                <input type="email" id="contact-email" required placeholder="jean.dupont@techcorp.fr">
            </div>
            
            <div class="form-group">
                <label for="password">Mot de passe *</label>
                <input type="password" id="password" required minlength="8" placeholder="Minimum 8 caract√®res">
            </div>
            
            <div class="form-group">
                <label for="password-confirm">Confirmer le mot de passe *</label>
                <input type="password" id="password-confirm" required placeholder="R√©p√©tez le mot de passe">
                <p class="error" id="password-error">Les mots de passe ne correspondent pas</p>
            </div>
            
            <div class="form-group">
                <label for="address">Adresse du si√®ge</label>
                <input type="text" id="address" placeholder="12 Rue de la Paix, 75001 Paris">
            </div>
            
            <!-- Sites de l'entreprise -->
            <div class="form-group">
                <label>Sites de l'entreprise (optionnel)</label>
                <p class="help-text">Ajoutez les adresses de vos diff√©rents sites pour la carte du dashboard</p>
                <div id="sites-container">
                    <div class="site-entry">
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <input type="text" class="site-name" placeholder="Nom du site (ex: Si√®ge social)" style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                        </div>
                        <div class="autocomplete-container">
                            <input type="text" class="site-address" placeholder="Rechercher une adresse..." 
                                   style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;"
                                   oninput="searchAddress(this)">
                            <div class="autocomplete-results"></div>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addSiteEntry()" style="background: #e5e7eb; color: #374151; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; margin-top: 8px;">
                    ‚ûï Ajouter un site
                </button>
            </div>
            
            <!-- Carte des sites -->
            <div class="map-container">
                <label>Visualisation des sites</label>
                <div id="sites-map"></div>
            </div>
            
            <div class="form-group">
                <label for="nb-employees">Nombre d'employ√©s *</label>
                <select id="nb-employees" required>
                    <option value="">S√©lectionnez...</option>
                    <option value="1-10">1 √† 10 (Gratuit)</option>
                    <option value="11-50">11 √† 50 (49‚Ç¨/mois)</option>
                    <option value="51-200">51 √† 200 (149‚Ç¨/mois)</option>
                    <option value="200+">Plus de 200 (Sur devis)</option>
                </select>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="accept-terms" required>
                <label for="accept-terms">
                    J'accepte les <a href="/legal/cgu.html" target="_blank">CGU</a> et la 
                    <a href="/legal/privacy.html" target="_blank">politique de confidentialit√©</a>
                </label>
            </div>
            
            <button type="submit" class="btn" id="submit-btn">Cr√©er mon compte</button>
        </form>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 16px; color: #64748b;">Cr√©ation du compte...</p>
        </div>
        
        <div class="success-message" id="success-message">
            <h3>‚úÖ Compte cr√©√© avec succ√®s !</h3>
            <p>Voici votre code entreprise √† partager avec vos employ√©s :</p>
            <div class="code-box" id="company-code">XXXXX</div>
            <p style="margin-top: 16px;">
                <strong>Prochaines √©tapes :</strong><br>
                1. Consultez votre email pour activer votre compte<br>
                2. Partagez le code ci-dessus avec vos employ√©s<br>
                3. Acc√©dez √† votre <a href="/dashboard-company.html" style="color: #667eea;">dashboard</a>
            </p>
        </div>
        
        <div class="back-link">
            <a href="/">‚Üê Retour √† l'accueil</a>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('signup-form');
        const submitBtn = document.getElementById('submit-btn');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('success-message');
        
        // Initialiser la carte
        let sitesMap = null;
        let siteMarkers = [];
        
        document.addEventListener('DOMContentLoaded', () => {
            sitesMap = L.map('sites-map').setView([46.603354, 1.888334], 6); // Centre de la France
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(sitesMap);
            
            // Fix pour les tuiles grises
            setTimeout(() => sitesMap.invalidateSize(), 100);
        });
        
        // Autocomplete d'adresse avec Nominatim
        let searchTimeout = null;
        
        async function searchAddress(input) {
            clearTimeout(searchTimeout);
            
            const query = input.value.trim();
            const resultsDiv = input.nextElementSibling;
            
            if (query.length < 3) {
                resultsDiv.classList.remove('show');
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=fr&limit=5`);
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        resultsDiv.innerHTML = '<div class="autocomplete-item" style="color: #9ca3af;">Aucun r√©sultat</div>';
                        resultsDiv.classList.add('show');
                        return;
                    }
                    
                    resultsDiv.innerHTML = results.map(r => 
                        `<div class="autocomplete-item" data-address="${r.display_name.replace(/"/g, '&quot;')}" data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name}</div>`
                    ).join('');
                    resultsDiv.classList.add('show');
                    
                    // Attacher les √©v√©nements de clic
                    resultsDiv.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('click', function() {
                            selectAddress(this);
                        });
                    });
                } catch (error) {
                    console.error('Erreur recherche adresse:', error);
                }
            }, 300);
        }
        
        function selectAddress(element) {
            const resultsDiv = element.parentElement;
            const input = resultsDiv.previousElementSibling;
            
            const address = element.dataset.address;
            const lat = element.dataset.lat;
            const lon = element.dataset.lon;
            
            input.value = address;
            input.dataset.lat = lat;
            input.dataset.lon = lon;
            resultsDiv.classList.remove('show');
            
            // Ajouter le marqueur sur la carte
            updateMapMarkers();
        }
        
        function updateMapMarkers() {
            // Supprimer tous les marqueurs existants
            siteMarkers.forEach(marker => sitesMap.removeLayer(marker));
            siteMarkers = [];
            
            // Ajouter les nouveaux marqueurs
            const bounds = [];
            
            document.querySelectorAll('.site-entry').forEach((entry, index) => {
                const nameInput = entry.querySelector('.site-name');
                const addressInput = entry.querySelector('.site-address');
                const name = nameInput.value.trim() || `Site ${index + 1}`;
                const lat = parseFloat(addressInput.dataset.lat);
                const lon = parseFloat(addressInput.dataset.lon);
                
                if (lat && lon) {
                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            html: 'üìç',
                            className: 'custom-marker',
                            iconSize: [30, 30]
                        })
                    }).addTo(sitesMap);
                    
                    marker.bindPopup(`<strong>${name}</strong><br>${addressInput.value}`);
                    siteMarkers.push(marker);
                    bounds.push([lat, lon]);
                }
            });
            
            // Ajuster la vue pour voir tous les marqueurs
            if (bounds.length > 0) {
                sitesMap.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Fonction pour ajouter un champ site
        function addSiteEntry() {
            const container = document.getElementById('sites-container');
            const entry = document.createElement('div');
            entry.className = 'site-entry';
            entry.innerHTML = `
                <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                    <input type="text" class="site-name" placeholder="Nom du site" 
                           style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;"
                           oninput="updateMapMarkers()">
                    <button type="button" onclick="this.closest('.site-entry').remove(); updateMapMarkers();" 
                            style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer;">‚úï</button>
                </div>
                <div class="autocomplete-container">
                    <input type="text" class="site-address" placeholder="Rechercher une adresse..." 
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;"
                           oninput="searchAddress(this)">
                    <div class="autocomplete-results"></div>
                </div>
            `;
            container.appendChild(entry);
        }
        
        // Fermer l'autocomplete quand on clique ailleurs
        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('site-address')) {
                document.querySelectorAll('.autocomplete-results').forEach(r => r.classList.remove('show'));
            }
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validation
            if (!document.getElementById('accept-terms').checked) {
                alert('Veuillez accepter les CGU');
                return;
            }
            
            // R√©cup√©rer les sites
            const sites = [];
            document.querySelectorAll('.site-entry').forEach(entry => {
                const name = entry.querySelector('.site-name').value.trim();
                const addressInput = entry.querySelector('.site-address');
                const address = addressInput.value.trim();
                if (name && address) {
                    sites.push({ name, address });
                }
            });
            
            // V√©rifier les mots de passe
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('password-confirm').value;
            
            if (password !== passwordConfirm) {
                document.getElementById('password-error').style.display = 'block';
                return;
            }
            document.getElementById('password-error').style.display = 'none';
            
            if (password.length < 8) {
                alert('Le mot de passe doit contenir au moins 8 caract√®res');
                return;
            }
            
            // R√©cup√©rer les donn√©es
            const data = {
                name: document.getElementById('company-name').value.trim(),
                siren: document.getElementById('siren').value.trim() || null,
                email_domain: document.getElementById('email-domain').value.trim(),
                contact_name: document.getElementById('contact-name').value.trim(),
                contact_email: document.getElementById('contact-email').value.trim(),
                password: password,
                address: document.getElementById('address').value.trim() || null,
                sites: sites
            };
            
            // Afficher le loader
            form.style.display = 'none';
            loading.style.display = 'block';
            
            try {
                // Appeler l'API
                const response = await fetch('/api/v2/companies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de la cr√©ation du compte');
                }
                
                const result = await response.json();
                
                // Afficher le succ√®s
                loading.style.display = 'none';
                successMessage.style.display = 'block';
                document.getElementById('company-code').textContent = result.company_code;
                
                // Ajouter lien gestion avec magic link
                const managementLink = document.createElement('div');
                managementLink.style.cssText = 'margin-top: 24px; text-align: center;';
                managementLink.innerHTML = `
                    <a href="${result.management_url}" 
                       style="display: inline-block; padding: 16px 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                              color: white; text-decoration: none; border-radius: 12px; font-weight: 700; font-size: 16px;
                              box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: transform 0.2s;"
                       onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        ‚öôÔ∏è G√©rer mes employ√©s et sites
                    </a>
                    <div style="margin-top: 16px; padding: 12px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 8px;">
                        <strong>üìß Email envoy√© :</strong> Un lien d'acc√®s permanent a √©t√© envoy√© √† ${result.contact_email || 'votre email'}.
                        <br>Vous pourrez toujours acc√©der √† votre espace via ce lien.
                    </div>
                `;
                successMessage.appendChild(managementLink);
                
                // Envoyer un email de confirmation (c√¥t√© serveur)
                console.log('Compte cr√©√©:', result);
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la cr√©ation du compte: ' + error.message);
                loading.style.display = 'none';
                form.style.display = 'block';
            }
        });
        
        // Validation SIREN en temps r√©el
        document.getElementById('siren').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').substring(0, 9);
        });
    </script>
</body>
</html>
